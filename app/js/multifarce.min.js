/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 * 
 * Event source "class"
 * Adds event functionality to an object.
 */
var EventSource=function(){var e={},c=arguments,d,a,b,f=Array.prototype.slice;for(d=0,a=c.length;d<a;d++){b=c[d];if(typeof b!="string"){throw"Type error (argument); expected string."}e[b]=[]}this.clearHandlers=function(g){if(g){if(typeof g!="string"){throw"Type error (event); expected string."}if(!(g in e)){throw"Unsupported event: "+g}e[g].length=0}else{for(var h in e){e[h].length=0}}};this.listen=function(h,g,i){if(typeof h!="string"){throw"Type error (event); expected string."}if(!(h in e)){throw"Unsupported event: "+h}if(typeof g!="function"){throw"Type error (handler); expected function."}e[h].push([g,i||this])};this.raise=function(k){var m=e[k],j,g,h=f.call(arguments,1);for(j=0,g=m.length;j<g;j++){m[j][0].apply(m[j][1],h)}};this.unlisten=function(j,h,l){if(typeof j!="string"){throw"Type error (event); expected string."}if(!(j in e)){throw"Unsupported event: "+j}var k=e[j],g;for(g=k.length-1;g>=0;g--){if(k[g][0]==h){if(l&&l!=k[g][1]){continue}k.splice(g,1)}}}};
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 * 
 * Hash handler
 * Keeps track of the history of changes to the hash part in the address bar.
 */
var Hash=(function(){var h=this,f=document.documentMode,g=h.history,k=h.location,b,l,e,c,d=function(){if(!k.search){return k.hash.substr(1)}var m=k.href.indexOf("#");return(m==-1?"":k.href.substr(m+1))},i=function(){var m=d();if(m!=e){e=m;l(m)}},a=function(m){try{var o=c.contentWindow.document;o.open();o.write("<html><body>"+m+"</body></html>");o.close();e=m}catch(n){setTimeout(function(){a(m)},10)}},j=function(){try{c.contentWindow.document}catch(n){setTimeout(j,10);return}a(e);var m=e;setInterval(function(){var o,p;try{o=c.contentWindow.document.body.innerText;if(o!=m){m=o;k.hash=e=o;l(o)}else{p=d();if(p!=e){a(p)}}}catch(q){}},50)};return{init:function(m,n){if(l){return}l=m;e=d();m(e);if(h.ActiveXObject){if(!f||f<8){c=n;j()}else{h.attachEvent("onhashchange",i)}}else{if(g.navigationMode!==b){g.navigationMode="compatible"}setInterval(i,50)}},go:function(m){if(m==e){return}if(c){a(m)}else{k.hash=e=m;l(m)}}}})();
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 * 
 * Simple JSON encoder/decoder
 * Encodes/decodes JavaScript values as JSON (see http://json.org/)
 */
var JSON=(function(){var c=new RegExp('[\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\ufeff\ufff0-\uffff]',"g"),a={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},b=function(d){return a[d]||"\\u"+("000"+d.charCodeAt(0).toString(16)).slice(-4)};return{dumps:function(h){switch(typeof h){case"string":return'"'+h.replace(c,b)+'"';case"object":if(h==null){return"null"}var e=[],g,f,d,j;if(h instanceof Array){for(f=0,d=h.length;f<d;f++){if((g=JSON.dumps(h[f]))!=null){e[e.length]=g}}return"["+e+"]"}for(j in h){if((g=JSON.dumps(h[j]))!=null){e[e.length]=JSON.dumps(j)+":"+g}}return"{"+e+"}";case"number":return isFinite(h)?String(h):"null";case"boolean":return String(h)}return null},loads:function(d){if(typeof d!="string"){return null}return JSON.e("("+d+")")}}})();JSON.e=function(c){return eval(c)};
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 * 
 * Service client library (Depends on jQuery, JSON)
 * Handles communication with an API through simple HTTP requests.
 */
var ServiceClient=(function(d,e){var b=function(i,h,j,f){if(f!="timeout"){return}i.attempts++;if(i.attempts<3){d.ajax(h)}else{var g={message:"The request failed after "+i.attempts+" attempt(s).",type:"JavaScriptError"};if(i.onError){i.onError.call(i.bindError||i.bind,g)}else{alert(g.type+": "+g.message)}}},c=function(g,f){switch(f.status){case"error":if(g.onError){g.onError.call(g.bindError||g.bind,f.response)}else{alert(f.response.type+": "+f.response.message)}break;case"list":break;case"success":if(g.onSuccess){g.onSuccess.call(g.bind,f.response)}break;default:alert("Unknown status: "+f.status);break}},a=function(k){var j,i=null,g=null,f=[],h=false;this.set_errorHandler=function(l,m){if(l===null){i=null;return}if(typeof l!="function"){throw"Type error (func); expected function or null."}if(typeof m!="object"){throw"Type error (bind); expected object."}i=l;g=m};this.get_path=function(){return k};this.call=function(n,t,s,r,p,o){if(typeof n!="string"){throw"Type error (action); expected string."}if(h){f[f.length]=arguments;return}h=true;var l={attempts:0,bind:r,bindError:o||g,onError:p||i,onSuccess:s};var m=[];for(var v in t){var w=e.dumps(t[v]);if(w){m[m.length]=v+"="+encodeURIComponent(w)}}var u=this;d.ajax({cache:false,complete:function(){h=false;if(f.length>0){u.call.apply(u,f.shift())}},data:m.join("&"),dataType:"json",error:function(x,q){b(l,this,x,q)},success:function(q){c(l,q)},timeout:3000,url:k+n})}};return a})(jQuery,JSON);
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 * 
 * jQuery hash plugin (Depends on jQuery, Hash)
 * Plugin for detecting changes to the hash and for adding history support for
 * hashes to certain browsers.
 */
(function(i,e){var d="jquery-history",f="/js/blank.html",a="hashchange",j="hash.fn",h,c=this,b=document.documentMode,g=function(k){i.event.trigger(a,[k])};i.hash={init:function(l){if(h){return}h=1;var k;if(c.ActiveXObject&&(!b||b<8)){i("body").prepend('<iframe id="'+d+'" style="display:none;" src="'+(l||f)+'"></iframe>');k=i("#"+d)[0]}e.init(g,k)},go:e.go};i.fn.hash=function(l,m){var k=this.data(j);if(k){this.unbind("click",k)}if(typeof l=="string"){k=function(){e.go(l);return false};this.data(j,k);this.click(k);if(m||m===undefined){this.attr("href","#"+l)}}return this};i.fn[a]=function(k){return this.bind(a,k)}})(jQuery,Hash);
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 * This and more JavaScript libraries: http://blixt.org/js
 * MIT License: http://www.opensource.org/licenses/mit-license.php
 *
 * Application handler
 *
 * Handles path maps that direct control to handlers, along with the query
 * string parameters. Recommended use is for supporting paths in the hash part
 * of the address bar.
 */
var Application=(function(){var a=function(f){var e=[],b=[],d=function(h,g){if(typeof h=="string"){h=new RegExp(h)}if(!(h instanceof RegExp)){throw"Type error (pattern); expected RegExp or string."}if(typeof g!="function"){throw"Type error (handler); expected function."}e.push(h);b.push(g)};for(var c=0;c<f.length;c++){d(f[c][0],f[c][1])}this.exec=function(n){var m,j,p={},k,o,h,g;if((h=n.indexOf("?"))>=0){k=n.substr(h+1).split("&");n=n.substr(0,h);for(h=0,g=k.length;h<g;h++){o=k[h].split("=",2);p[decodeURIComponent(o[0])]=(o.length==2?decodeURIComponent(o[1].replace(/\+/g," ")):true)}}for(h=0,g=e.length;h<g;h++){m=e[h].exec(n);if(m){m=m.slice(1);j=new b[h](this,n,m,p);j.run.apply(j,m);return}}}};a.handler=function(b){var c=function(g,e,d,f){this.get_param=function(h,i){return(h in f?f[h]:i)};this.get_matches=function(){var k=[],j,h;for(j=0,h=d.length;j<h;j++){k[j]=d[j]}return k};this.get_params=function(){var h={},i;for(i in f){h[i]=f[i]}return h};this.get_path=function(){return e};this.get_app=function(){return g}};c.prototype={delay:function(e){var d=this;return setTimeout(function(){d.run.apply(d,d.get_matches())},e)},redirect:function(e){var f=this.get_matches(),d=new e(this.get_app(),this.get_path(),f,this.get_params());d.run.apply(d,f)},run:b};return c};return a})();
/*
 * Copyright (c) 2009 Andreas Blixt <andreas@blixt.org>
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 * 
 * multifarce client library
 * Dependencies: Application, EventSource, Hash, jQuery, jQuery hash plugin,
 *               ServiceClient
 */
jQuery.fn.formattedText=function(b){var a="<p>"+this.text(b).html()+"</p>";a=a.replace(/\*([^*\r\n]+)\*/g,"<strong>$1</strong>");a=a.replace(/_([^_\r\n]+)_/g,"<em>$1</em>");a=a.replace(/(\r\n|[\r\n]){2,}/g,"</p><p>");a=a.replace(/(\r\n|[\r\n])/g,"<br/>");return this.html(a)};jQuery.fn.hasEvent=function(b){var a=this.data("events");return a&&a[b]};var Multifarce=(function(a,f,k,g,i){var c="multifarce",e=function(){var n=arguments[0],m;for(m=1;m<arguments.length;m++){arguments[m].remove()}this.current=function(o){if(o){return o==n}return n};this.show=function(o){if(n==o){return}n.replaceWith(o);n=o}},d=(function(){var m=function(){i.call(this,"/api/")};m.prototype={createCommand:function(o,n,t,q,s,r,p){this.simpleCall("create_command",{frame:o,commands:n,text:t,go_to_frame:q,flags_on:s,flags_off:r,flags_required:p})},createFrame:function(o,n){this.simpleCall("create_frame",{title:o,text:n})},execute:function(p,o,n){this.simpleCall("execute",{frame:p,command:o,flags:n})},getCommand:function(n){this.simpleCall("get_command",{command:n})},getFirstFrame:function(){this.simpleCall("get_first_frame",{})},getFrame:function(n){this.simpleCall("get_frame",{frame:n})},getFrames:function(){this.simpleCall("get_frames",{})},getStatus:function(n){this.simpleCall("get_status",{path:n})},getUserInfo:function(n){this.simpleCall("get_user_info",{user:n})},logIn:function(o,n){this.simpleCall("log_in",{username:o,password:n})},logOut:function(){this.simpleCall("log_out",{})},register:function(q,n,p,o){this.simpleCall("register",{username:q,display_name:n,password:p,email:o})},onSuccess:null,onSuccessBind:null,onError:null,onErrorBind:null,error:function(n,o){this.onError=n;this.onErrorBind=o;return this},success:function(o,n){this.onSuccess=o;this.onSuccessBind=n;return this},simpleCall:function(o,n){this.call(o,n,this.onSuccess,this.onSuccessBind,this.onError,this.onErrorBind);this.onSuccess=null;this.onSuccessBind=null;this.onError=null;this.onErrorBind=null}};return m})(),h=new d(),j=(function(){var o={},m,n=function(t){f.call(this,"load");var q=false,r,p,s;p=function(){this.clearHandlers();if(t){delete o[t]}};s=function(u){r=u;q=true;this.raise("load")};this.get_displayName=function(){return r.display_name};this.get_emailHash=function(){return r.email_md5};this.get_username=function(){return r.username};this.isCurrent=function(){return this==m};this.isLoaded=function(){return q};if(!t){this.get_email=function(){return r.email};this.get_googleEmail=function(){return r.google_email};this.get_googleLogUrl=function(){return r.google_login||r.google_logout};this.get_googleNickname=function(){return r.google_nickname};this.get_type=function(){return r.type};this.googleLoggedIn=function(){return r.google_logged_in};this.loggedIn=function(){return r.logged_in}}this.load=function(){h.success(s,this).error(p,this);if(t){h.getUserInfo(t)}else{h.getStatus()}}};n.current=function(){if(!m){m=new n()}return m};n.get=function(p){if(typeof p!="string"){throw"Invalid type (username); expected string."}if(p in o){return o[p]}else{o[p]=new n(p)}};return n})(),b=(function(){var m=function(r){f.call(this,"execute-success","execute-error","frame-load");var t,q,o,s=function(u){this.raise("execute-error",u)},p=function(u){if(u.frame_id!=t){t=u.frame_id;r.success(n,this).getFrame(t)}o=u.flags;this.raise("execute-success",u)},n=function(u){t=u.id;q=u.title;this.raise("frame-load",u)};this.get_frameId=function(){return t};this.get_frameTitle=function(){return q};this.get_state=function(){return t+","+o.join(",")};this.set_state=function(w){var v=w.split(","),x=parseInt(v.shift(),10);if(x&&x!=t){for(var u=v.length-1;u>0;u--){if(!v[u]){v.splice(u,1)}}l.start(x,v)}};this.execute=function(u){if(!u){return}if(!t){this.raise("execute-error",{message:"The game has not been started!"});return}r.error(s,this).success(p,this);r.execute(t,u,o)};this.start=function(u,v){t=u||0;o=v||[];r.success(n,this);if(t>0){r.getFrame(t)}else{r.getFirstFrame()}}};return m})(),l=new b(h);return{init:function(){var O=g("#notifications"),K=g("#page-name"),I=g("#username"),w=g("#avatar img"),S=g("#home"),m=S.find("#current-frame"),p=m.find("h3"),H=m.find("div.text"),Q=S.find("#action"),s=S.find("#action-go"),R=S.find("#log"),W=g("#new-command"),t=g("#new-command-frame"),F=g("#new-command-1"),E=g("#new-command-2"),C=g("#new-command-3"),B=g("#new-command-4"),A=g("#new-command-5"),z=g("#new-command-text"),V=g("#new-command-go-to-frame"),q=g("#new-command-create"),G=g("#new-frame"),T=g("#new-frame-title"),o=g("#new-frame-text"),r=g("#new-frame-create"),U=g("#not-found"),L=g("#not-found-path"),P=g("#register"),n=new e(S,W,G,U,P),M=j.current(),D=function(Y,X){if(Y){K.text(Y);document.title=Y+" - "+c}if(X){n.show(X)}},N=function(){var X=Q.val();if(!X){return}Q.val("");R.prepend(g('<div class="command"/>').text("> "+X));if(X=="reset"||X=="start"){R.prepend(g('<div class="result"/>').text("Starting..."));l.start()}else{l.execute(X)}},v=function(Y,X){O.empty();O.append(g("<p/>").addClass(X||"message").append(g('<a href="#"/>').text(Y)).hide().fadeIn(500).fadeOut(15000,function(){g(this).remove()}))},y=a.handler(function(X){}),x=a.handler(function(){var X=l.get_frameId(),Y=this.get_param("state");if(Y){l.set_state(Y)}else{if(X>0){g.hash.go("?state="+l.get_state())}}D(l.get_frameTitle(),S);if(!Q.hasEvent("keydown")){Q.keydown(function(Z){if(Z.keyCode==13){N()}});s.click(N)}}),J=a.handler(function(){t.find("option").remove();V.find("option").remove();h.success(function(Y){for(var X=0;X<Y.length;X++){t.append(g("<option/>").val(Y[X].id).text(Y[X].title));V.append(g("<option/>").val(Y[X].id).text(Y[X].title))}}).getFrames();D("Creating new command",W);q.click(function(){var X=[];if(F.val()){X.push(F.val())}if(E.val()){X.push(E.val())}if(C.val()){X.push(C.val())}if(B.val()){X.push(B.val())}if(A.val()){X.push(A.val())}h.success(function(){alert("Success!")}).createCommand(parseInt(t.val()),X,z.val(),parseInt(V.val()))})}),u=a.handler(function(){D("Creating new frame",G);r.click(function(){h.success(function(){alert("Success!")}).createFrame(T.val(),o.val())})});NotFoundHandler=a.handler(function(){L.text(this.get_path());D("Path not found!",U)}),RegisterHandler=a.handler(function(){D("Register",P)}),UserHandler=a.handler(function(X){}),site=new a([["^$",x],["^commands/(\d+)$",y],["^commands/new$",J],["^frames/new$",u],["^register$",RegisterHandler],["^user/([^/]+)$",UserHandler],["^.*$",NotFoundHandler]]);g(document).hashchange(function(Y,X){site.exec(X)});g.hash.init();M.listen("load",function(){if(this.loggedIn()){I.text(this.get_displayName());w.attr("src","http://www.gravatar.com/avatar/"+this.get_emailHash()+"?s=28&d=identicon&r=PG")}});M.load();l.listen("frame-load",function(X){if(l.get_frameId()){g.hash.go("?state="+l.get_state())}D(X.title,S);m.stop(true).animate({height:0,opacity:0},400).queue(function(){p.text(X.title);H.formattedText(X.text);m.css({position:"absolute",height:"auto"});m.animate({height:m.height(),opacity:1},1000);m.css({height:0,position:"static"});m.dequeue()});R.prepend(g('<div class="frame"/>').append(g('<p class="entering"/>').append("Entering ").append(g("<strong/>").text(X.title))).append(g("<div/>").formattedText(X.text)))});l.listen("execute-error",function(X){v(X.message,"error");R.prepend(g('<div class="result"/>').text(X.message))});l.listen("execute-success",function(X){g.hash.go("?state="+l.get_state());v(X.text,"success");R.prepend(g('<div class="result"/>').text(X.text))});Q.focus()},api:h,game:l,user:j}})(Application,EventSource,Hash,jQuery,ServiceClient);jQuery(Multifarce.init);